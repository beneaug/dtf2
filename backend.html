<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, viewport-fit=cover"
    />
    <title>DTF Operator Console</title>
    <link rel="stylesheet" href="styles.css" />
  </head>
  <body class="order-body">
    <!-- Reuse the same operator console markup and script as ops.html -->
    <div class="page-root">
      <div class="bg-gradient-root">
        <div class="bg-gradient-wrapper">
          <div class="bg-gradient-image"></div>
        </div>
        <div class="bg-grain-overlay"></div>
      </div>

      <main class="order-page">
        <header class="order-hero">
          <h1>DTF operator console</h1>
          <p>
            Review incoming transfer jobs, download artwork, and mark orders as
            completed.
          </p>
        </header>

        <section class="order-shell">
          <div class="order-card" id="ops-root">
            <div id="ops-login">
              <h2 class="ops-subheading">Sign in</h2>
              <form id="ops-login-form" class="order-form" novalidate>
                <label class="order-field">
                  <span class="order-field-label">Username</span>
                  <input
                    type="text"
                    class="order-input"
                    name="username"
                    autocomplete="username"
                  />
                </label>
                <label class="order-field">
                  <span class="order-field-label">Password</span>
                  <input
                    type="password"
                    class="order-input"
                    name="password"
                    autocomplete="current-password"
                  />
                </label>
                <button class="order-primary-btn" type="submit">
                  Sign in
                </button>
                <div class="order-status" id="ops-login-status"></div>
              </form>
            </div>

            <div id="ops-orders" style="display: none">
              <h2 class="ops-subheading">Pending &amp; recent orders</h2>
              <div class="order-status" id="ops-orders-status"></div>

              <div class="ops-layout">
                <section class="ops-list-column" aria-label="Order queue">
                  <div class="ops-order-list" id="ops-order-list"></div>
                </section>

                <aside
                  class="ops-detail-column"
                  aria-label="Order details"
                  id="ops-detail-column"
                >
                  <div
                    class="ops-detail-placeholder"
                    id="ops-detail-placeholder"
                  >
                    Select an order to see full job specs, artwork, and
                    downloads.
                  </div>
                  <div class="ops-detail-card" id="ops-detail" hidden></div>
                </aside>
              </div>
            </div>
          </div>
        </section>
      </main>
    </div>

    <script>
      async function opsFetch(url, options) {
        const res = await fetch(url, {
          credentials: "include",
          ...options,
        });
        if (res.status === 401) {
          throw new Error("unauthorized");
        }
        return res;
      }

      function setText(el, text) {
        if (!el) return;
        el.textContent = text;
      }

      const OPS_THUMBNAIL_CACHE = {};
      let OPS_CURRENT_ORDERS = [];

      function addBusinessDays(date, businessDays) {
        const result = new Date(date.getTime());
        let added = 0;
        while (added < businessDays) {
          result.setDate(result.getDate() + 1);
          const day = result.getDay();
          if (day !== 0 && day !== 6) {
            added++;
          }
        }
        return result;
      }

      function formatShortDateTime(date) {
        return `${date.toLocaleDateString(undefined, {
          month: "short",
          day: "numeric",
        })} · ${date.toLocaleTimeString(undefined, {
          hour: "2-digit",
          minute: "2-digit",
        })}`;
      }

      function formatShortDate(date) {
        return date.toLocaleDateString(undefined, {
          weekday: "short",
          month: "short",
          day: "numeric",
        });
      }

      function formatMoneyFromCents(cents) {
        if (cents == null || Number.isNaN(cents)) return null;
        return `$${(cents / 100).toFixed(2)}`;
      }

      function getFileMimeType(file) {
        if (!file || typeof file !== "object") return "";
        return (
          file.mimetype ||
          file.mimeType ||
          (file.filename &&
            (file.filename.mimetype || file.filename.mimeType)) ||
          ""
        );
      }

      function getFileDisplayName(file, fallbackIndex) {
        if (!file || typeof file !== "object") {
          return fallbackIndex != null ? `File ${fallbackIndex + 1}` : "File";
        }
        if (typeof file.filename === "string") return file.filename;
        if (typeof file.originalname === "string") return file.originalname;
        if (
          file.filename &&
          typeof file.filename.filename === "string"
        ) {
          return file.filename.filename;
        }
        return fallbackIndex != null ? `File ${fallbackIndex + 1}` : "File";
      }

      async function loadThumbnail(order, thumbContainer, size = "small") {
        if (!thumbContainer) return;

        const files = Array.isArray(order.files) ? order.files : [];
        if (!files.length) {
          thumbContainer.innerHTML =
            '<div class="ops-order-thumb-empty">No art</div>';
          return;
        }

        const firstImageIndex = files.findIndex((f) => {
          const mime = getFileMimeType(f);
          return typeof mime === "string" && mime.startsWith("image/");
        });
        const imageIndex = firstImageIndex >= 0 ? firstImageIndex : 0;

        const cacheKey = `${order.id}:${imageIndex}`;
        if (OPS_THUMBNAIL_CACHE[cacheKey]) {
          const file = files[imageIndex];
          const img = document.createElement("img");
          img.src = OPS_THUMBNAIL_CACHE[cacheKey];
          img.alt = getFileDisplayName(file, imageIndex) || "Artwork";
          thumbContainer.innerHTML = "";
          thumbContainer.appendChild(img);
          return;
        }

        try {
          const res = await opsFetch(
            `/api/operator/file?orderId=${order.id}&index=${imageIndex}`
          );
          const data = await res.json();
          if (!res.ok || !data.ok || !data.url) {
            throw new Error(data.error || "Failed to load artwork thumbnail.");
          }
          OPS_THUMBNAIL_CACHE[cacheKey] = data.url;
          const file = files[imageIndex];
          const img = document.createElement("img");
          img.src = data.url;
          img.alt = getFileDisplayName(file, imageIndex) || "Artwork";
          thumbContainer.innerHTML = "";
          thumbContainer.appendChild(img);
        } catch (err) {
          console.error(err);
          thumbContainer.innerHTML =
            '<div class="ops-order-thumb-empty">Artwork unavailable</div>';
        }
      }

      function renderOrderDetail(order) {
        const detailEl = document.getElementById("ops-detail");
        const placeholderEl = document.getElementById("ops-detail-placeholder");
        if (!detailEl || !placeholderEl || !order) return;

        const created = new Date(order.created_at);
        const due = addBusinessDays(created, 3);
        const now = new Date();
        const isOverdue =
          order.status !== "completed" &&
          due.getTime() < now.getTime() - 5 * 60 * 1000;

        const unitPrice = formatMoneyFromCents(order.unit_price_cents);
        const totalPrice = formatMoneyFromCents(order.total_price_cents);
        const files = Array.isArray(order.files) ? order.files : [];

        const statusLower = (order.status || "pending").toLowerCase();

        detailEl.innerHTML = `
          <header class="ops-detail-header">
            <div class="ops-detail-title-group">
              <h3 class="ops-detail-title">${order.transfer_name || "Untitled job"}</h3>
              <p class="ops-detail-subtitle">
                Job #${order.id} · ${
                  order.garment_color || "Garment color not specified"
                }
              </p>
            </div>
            <div class="ops-detail-badges">
              <span class="ops-status-pill ops-status-pill--${statusLower}">
                ${statusLower}
              </span>
            </div>
          </header>

          <section class="ops-detail-art-section">
            <div class="ops-detail-art" id="ops-detail-art-${order.id}">
              <div class="ops-order-thumb-empty">Loading artwork…</div>
            </div>
            <div class="ops-detail-dates">
              <div class="ops-detail-date-row">
                <span class="ops-detail-label">Received</span>
                <span class="ops-detail-value">${formatShortDateTime(
                  created
                )}</span>
              </div>
              <div class="ops-detail-date-row">
                <span class="ops-detail-label">Due (3 business days)</span>
                <span class="ops-detail-value">
                  ${formatShortDate(due)}${
          isOverdue ? ' · <span class="ops-detail-overdue">Overdue</span>' : ""
        }
                </span>
              </div>
            </div>
          </section>

          <section class="ops-detail-grid" aria-label="Job details">
            <div class="ops-detail-grid-item">
              <span class="ops-detail-label">Quantity</span>
              <span class="ops-detail-value">${order.quantity || "—"}</span>
            </div>
            <div class="ops-detail-grid-item">
              <span class="ops-detail-label">Transfer size</span>
              <span class="ops-detail-value">${order.size || "—"}</span>
            </div>
            <div class="ops-detail-grid-item">
              <span class="ops-detail-label">Mode</span>
              <span class="ops-detail-value">${order.mode || "—"}</span>
            </div>
            <div class="ops-detail-grid-item">
              <span class="ops-detail-label">Pricing</span>
              <span class="ops-detail-value">
                ${
                  unitPrice && totalPrice
                    ? `${unitPrice} per · ${totalPrice} total`
                    : "Not recorded"
                }
              </span>
            </div>
          </section>

          <section class="ops-detail-notes">
            <h4 class="ops-detail-section-heading">Shipping address</h4>
            <p class="ops-detail-notes-body">
              ${
                order.shipping_address
                  ? (() => {
                      try {
                        const addr = typeof order.shipping_address === 'string' 
                          ? JSON.parse(order.shipping_address) 
                          : order.shipping_address;
                        const parts = [];
                        if (addr.name) parts.push(addr.name);
                        if (addr.line1) parts.push(addr.line1);
                        if (addr.line2) parts.push(addr.line2);
                        const cityState = [addr.city, addr.state].filter(Boolean).join(', ');
                        if (cityState) parts.push(cityState);
                        const zipCountry = [addr.postal_code, addr.country].filter(Boolean).join(' ');
                        if (zipCountry) parts.push(zipCountry);
                        return parts.length > 0 
                          ? parts.join('<br>') 
                          : 'No shipping address provided.';
                      } catch (e) {
                        return 'Shipping address unavailable.';
                      }
                    })()
                  : 'No shipping address collected for this order.'
              }
            </p>
          </section>

          ${
            order.gang_sheet_data
              ? `<section class="ops-detail-notes">
                  <h4 class="ops-detail-section-heading">Gang Sheet Layout</h4>
                  <button 
                    class="ops-view-gang-sheet-btn" 
                    data-order-id="${order.id}"
                    type="button"
                  >
                    View Gang Sheet Layout
                  </button>
                </section>`
              : ""
          }

          <section class="ops-detail-notes">
            <h4 class="ops-detail-section-heading">Operator notes</h4>
            <p class="ops-detail-notes-body">
              ${order.notes ? order.notes : "No notes supplied with this job."}
            </p>
          </section>

          <section class="ops-detail-files">
            <div class="ops-detail-files-header">
              <h4 class="ops-detail-section-heading">Artwork &amp; files</h4>
              <span class="ops-detail-files-count">${
                files.length ? `${files.length} file${files.length === 1 ? "" : "s"}` : "No files"
              }</span>
            </div>
            <div class="ops-detail-files-list">
              ${
                files.length
                  ? files
                      .map((file, index) => {
                        const mime = getFileMimeType(file);
                        const isImage =
                          typeof mime === "string" && mime.startsWith("image/");
                        const displayName = getFileDisplayName(file, index);
                        return `
                          <div class="ops-file-row">
                            <div class="ops-file-main">
                              <div class="ops-file-name">${
                                displayName
                              }</div>
                              <div class="ops-file-meta">
                                ${isImage ? "Image" : "File"} · ${
                          mime || "Unknown type"
                        }${
                          file.size
                            ? ` · ${(file.size / 1024).toFixed(1)} KB`
                            : ""
                        }
                              </div>
                            </div>
                            <div class="ops-file-actions">
                              <button
                                type="button"
                                class="ops-view-file"
                                data-order-id="${order.id}"
                                data-file-index="${index}"
                              >
                                Open
                              </button>
                            </div>
                          </div>
                        `;
                      })
                      .join("")
                  : `<p class="ops-detail-notes-body">No artwork files are attached to this order.</p>`
              }
            </div>
          </section>
        `;

        placeholderEl.style.display = "none";
        detailEl.hidden = false;

        const artContainer = document.getElementById(
          `ops-detail-art-${order.id}`
        );
        if (artContainer) {
          loadThumbnail(order, artContainer, "large");
        }

        // Setup gang sheet viewer button
        if (order.gang_sheet_data) {
          const viewBtn = document.querySelector(
            `.ops-view-gang-sheet-btn[data-order-id="${order.id}"]`
          );
          if (viewBtn) {
            viewBtn.addEventListener('click', () => {
              openGangSheetModal(order.gang_sheet_data, order.id);
            });
          }
        }
      }

      async function openGangSheetModal(gangSheetData, orderId) {
        if (!gangSheetData) return;

        try {
          const data = typeof gangSheetData === 'string' 
            ? JSON.parse(gangSheetData) 
            : gangSheetData;

          // Create modal overlay matching gang builder style
          const modal = document.createElement('div');
          modal.className = 'ops-gang-sheet-modal';
          modal.innerHTML = `
            <div class="ops-gang-sheet-modal-content">
              <div class="ops-gang-sheet-modal-header">
                <h3 class="ops-gang-sheet-modal-title">Gang Sheet Layout - Order #${orderId}</h3>
                <button class="ops-gang-sheet-modal-close" type="button" aria-label="Close">×</button>
              </div>
              <div class="ops-gang-sheet-modal-body">
                <div class="ops-gang-sheet-info-grid">
                  <div class="ops-gang-sheet-info-item">
                    <span class="ops-detail-label">Sheet Size</span>
                    <span class="ops-detail-value">${data.sheetSizeId || '—'}</span>
                  </div>
                  <div class="ops-gang-sheet-info-item">
                    <span class="ops-detail-label">Quantity</span>
                    <span class="ops-detail-value">${data.quantity || '—'}</span>
                  </div>
                  <div class="ops-gang-sheet-info-item">
                    <span class="ops-detail-label">Usage</span>
                    <span class="ops-detail-value">${data.usageStats ? Math.round(data.usageStats.usagePct || 0) + '%' : '—'}</span>
                  </div>
                  <div class="ops-gang-sheet-info-item">
                    <span class="ops-detail-label">Instances</span>
                    <span class="ops-detail-value">${data.usageStats ? data.usageStats.instanceCount || 0 : '—'}</span>
                  </div>
                </div>
                <div class="gang-builder-center" style="min-height: 500px; height: 70vh;">
                  <div id="ops-gang-sheet-canvas-container-${orderId}"></div>
                </div>
              </div>
            </div>
          `;

          document.body.appendChild(modal);

          // Close handlers
          const closeBtn = modal.querySelector('.ops-gang-sheet-modal-close');
          const closeModal = () => {
            document.body.removeChild(modal);
          };
          closeBtn.addEventListener('click', closeModal);
          modal.addEventListener('click', (e) => {
            if (e.target === modal) closeModal();
          });
          document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && document.body.contains(modal)) {
              closeModal();
            }
          });

          // Load the actual gang builder canvas component
          const canvasContainer = modal.querySelector(`#ops-gang-sheet-canvas-container-${orderId}`);
          if (canvasContainer && data.instanceLayout && data.designFiles) {
            await loadGangSheetViewer(canvasContainer, data, orderId);
          }
        } catch (err) {
          console.error('Failed to open gang sheet modal:', err);
          alert('Failed to load gang sheet layout.');
        }
      }

      async function loadGangSheetViewer(container, data, orderId) {
        try {
          // Dynamically import the gang builder components
          const { create: createCanvas } = await import('./components/gang-builder/sheet-canvas.js');
          const storeModule = await import('./lib/gang-builder/store.js');
          
          // Get order to load images
          const order = OPS_CURRENT_ORDERS.find(o => Number(o.id) === Number(orderId));
          const orderFiles = order && Array.isArray(order.files) ? order.files : [];
          
          // Load images and create design files with URLs
          const designFilesWithUrls = await Promise.all(data.designFiles.map(async (file) => {
            // Find matching file in order
            const matchingFile = orderFiles.find(f => {
              // Ensure we have strings for comparison
              const fileName = String(f.filename || f.name || '').trim();
              const designFileName = String(file.name || '').trim();
              
              if (!fileName || !designFileName) return false;
              
              // Try exact match first, then partial matches
              return fileName === designFileName || 
                     fileName.includes(designFileName) || 
                     designFileName.includes(fileName);
            });
            
            let imageUrl = null;
            let imageLoaded = false;
            
            if (matchingFile) {
              try {
                const fileIndex = orderFiles.indexOf(matchingFile);
                const res = await opsFetch(`/api/operator/file?orderId=${orderId}&index=${fileIndex}`);
                const fileData = await res.json();
                if (res.ok && fileData.ok && fileData.url) {
                  imageUrl = fileData.url;
                  
                  // Preload the image to ensure it's ready
                  try {
                    const img = new Image();
                    img.crossOrigin = 'anonymous';
                    await new Promise((resolve, reject) => {
                      img.onload = () => {
                        imageLoaded = true;
                        resolve(img);
                      };
                      img.onerror = (err) => {
                        console.warn('Failed to preload image:', file.name, err);
                        resolve(null); // Continue even if image fails
                      };
                      img.src = imageUrl;
                    });
                  } catch (imgErr) {
                    console.error('Error preloading image:', file.name, imgErr);
                  }
                }
              } catch (err) {
                console.error('Error loading image URL:', err);
              }
            }
            
            return {
              id: file.id,
              name: file.name,
              url: imageUrl || 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNk+M9QDwADhgGAWjR9awAAAABJRU5ErkJggg==', // 1x1 transparent placeholder
              naturalWidthPx: file.naturalWidthPx,
              naturalHeightPx: file.naturalHeightPx,
              widthIn: file.widthIn,
              heightIn: file.heightIn,
              _imageLoaded: imageLoaded, // Track if image was successfully loaded
            };
          }));
          
          console.log('Loaded design files:', designFilesWithUrls.length);
          console.log('  Files with images:', designFilesWithUrls.filter(f => f.url && !f.url.startsWith('data:')).length);
          
          // Initialize store with the gang sheet data
          storeModule.resetAll();
          storeModule.setSheetSize(data.sheetSizeId);
          storeModule.setSheetQuantity(data.quantity);
          
          // Add design files
          designFilesWithUrls.forEach(file => {
            // Remove internal tracking property before adding to store
            const { _imageLoaded, ...fileForStore } = file;
            storeModule.addDesignFile(fileForStore);
          });
          
          // Preload all images into the canvas component's cache before creating it
          // We need to access the canvas component's preloadImage function
          // Since we can't access it directly, we'll create the canvas first, then trigger image loading
          
          // Create the canvas component first
          createCanvas(container);
          
          // Now preload all images by accessing the store and triggering renders
          // The canvas component will handle image loading via its preloadImage function
          // We need to wait a bit for the canvas to initialize, then trigger a render
          setTimeout(() => {
            // Force a re-render by updating the store (this will trigger canvas render)
            const currentState = storeModule.getState();
            storeModule.setSheetSize(currentState.selectedSheetSizeId);
          }, 100);
          
          // Group instances by design, then add them using auto-pack and immediately update positions
          const instancesByDesign = {};
          data.instanceLayout.forEach(inst => {
            if (!instancesByDesign[inst.designId]) {
              instancesByDesign[inst.designId] = [];
            }
            instancesByDesign[inst.designId].push(inst);
          });
          
          // For each design, create instances then immediately update to saved positions
          for (const [designId, savedInstances] of Object.entries(instancesByDesign)) {
            // Create instances using auto-pack (they'll be at wrong positions initially)
            storeModule.addInstancesForDesign(designId, savedInstances.length, true);
            
            // Get the instances we just created and update them to match saved layout
            const currentState = storeModule.getState();
            const createdInstances = currentState.instances.filter(i => i.designId === designId);
            
            // Update each instance to match saved position
            savedInstances.forEach((savedInst, index) => {
              if (createdInstances[index]) {
                storeModule.updateInstance(createdInstances[index].id, {
                  xIn: savedInst.xIn,
                  yIn: savedInst.yIn,
                  widthIn: savedInst.widthIn,
                  heightIn: savedInst.heightIn,
                  rotationDeg: savedInst.rotationDeg || 0,
                });
              }
            });
          }
        } catch (err) {
          console.error('Failed to load gang sheet viewer:', err);
          container.innerHTML = '<p class="ops-detail-notes-body">Failed to load gang sheet viewer. Check console for details.</p>';
        }
      }

      function renderGangSheetViewer(gangSheetData, container) {
        if (!gangSheetData || !container) return;

        try {
          const data = typeof gangSheetData === 'string' 
            ? JSON.parse(gangSheetData) 
            : gangSheetData;

          container.innerHTML = `
            <div class="ops-gang-sheet-info">
              <div class="ops-gang-sheet-info-item">
                <span class="ops-detail-label">Sheet Size</span>
                <span class="ops-detail-value">${data.sheetSizeId || '—'}</span>
              </div>
              <div class="ops-gang-sheet-info-item">
                <span class="ops-detail-label">Quantity</span>
                <span class="ops-detail-value">${data.quantity || '—'}</span>
              </div>
              <div class="ops-gang-sheet-info-item">
                <span class="ops-detail-label">Usage</span>
                <span class="ops-detail-value">${data.usageStats ? Math.round(data.usageStats.usagePct || 0) + '%' : '—'}</span>
              </div>
              <div class="ops-gang-sheet-info-item">
                <span class="ops-detail-label">Instances</span>
                <span class="ops-detail-value">${data.usageStats ? data.usageStats.instanceCount || 0 : '—'}</span>
              </div>
            </div>
            <div class="ops-gang-sheet-canvas-container">
              <canvas id="ops-gang-sheet-canvas-${Date.now()}" class="ops-gang-sheet-canvas"></canvas>
            </div>
          `;

          // Render the gang sheet on canvas
          const canvas = container.querySelector('canvas');
          if (canvas && data.instanceLayout && data.designFiles) {
            renderGangSheetCanvas(canvas, data);
          }
        } catch (err) {
          console.error('Failed to render gang sheet viewer:', err);
          container.innerHTML = '<p class="ops-detail-notes-body">Failed to load gang sheet layout.</p>';
        }
      }

      async function renderGangSheetCanvas(canvas, data, orderId) {
        if (!canvas || !data.instanceLayout || !data.designFiles) return;

        const ctx = canvas.getContext('2d');
        const PX_PER_INCH = 40; // Scale for display
        
        // Get sheet size
        const sheetSizes = {
          '22x12': { width: 22, height: 12 },
          '22x24': { width: 22, height: 24 },
          '22x60': { width: 22, height: 60 },
          '22x120': { width: 22, height: 120 },
          '22x180': { width: 22, height: 180 },
        };
        
        const sheetSize = sheetSizes[data.sheetSizeId] || sheetSizes['22x12'];
        const sheetWidthPx = sheetSize.width * PX_PER_INCH;
        const sheetHeightPx = sheetSize.height * PX_PER_INCH;
        
        // Set canvas size
        canvas.width = sheetWidthPx;
        canvas.height = sheetHeightPx;
        
        // Draw sheet background
        ctx.fillStyle = 'rgba(240, 240, 240, 0.1)';
        ctx.fillRect(0, 0, sheetWidthPx, sheetHeightPx);
        ctx.strokeStyle = 'rgba(255, 255, 255, 0.2)';
        ctx.lineWidth = 2;
        ctx.strokeRect(0, 0, sheetWidthPx, sheetHeightPx);
        
        // Create design file map and load images
        const designMap = new Map();
        const imageCache = new Map();
        
        data.designFiles.forEach(file => {
          designMap.set(file.id, file);
        });
        
        // Load all images first - find matching file by name from order
        const order = OPS_CURRENT_ORDERS.find(o => Number(o.id) === Number(orderId));
        const orderFiles = order && Array.isArray(order.files) ? order.files : [];
        
        const imagePromises = data.designFiles.map(async (file) => {
          try {
            // Find matching file in order by name
            const matchingFile = orderFiles.find(f => {
              const fileName = f.filename || f.name || '';
              return fileName === file.name || fileName.includes(file.name) || file.name.includes(fileName);
            });
            
            if (matchingFile) {
              // Use the file index to load the image
              const fileIndex = orderFiles.indexOf(matchingFile);
              const res = await opsFetch(`/api/operator/file?orderId=${orderId}&index=${fileIndex}`);
              const fileData = await res.json();
              
              if (res.ok && fileData.ok && fileData.url) {
                const img = new Image();
                img.crossOrigin = 'anonymous';
                await new Promise((resolve, reject) => {
                  img.onload = resolve;
                  img.onerror = () => {
                    console.warn('Failed to load image:', file.name);
                    resolve(); // Continue even if image fails
                  };
                  img.src = fileData.url;
                });
                imageCache.set(file.id, img);
              } else {
                console.warn('Failed to get image URL for:', file.name);
              }
            } else {
              console.warn('No matching file found for:', file.name);
            }
          } catch (err) {
            console.error('Error loading image:', file.name, err);
          }
        });
        
        await Promise.all(imagePromises);
        
        // Draw each instance
        data.instanceLayout.forEach(instance => {
          const design = designMap.get(instance.designId);
          if (!design) return;
          
          const x = instance.xIn * PX_PER_INCH;
          const y = instance.yIn * PX_PER_INCH;
          const width = instance.widthIn * PX_PER_INCH;
          const height = instance.heightIn * PX_PER_INCH;
          
          // Draw image if available
          const img = imageCache.get(instance.designId);
          if (img && img.complete && img.naturalWidth > 0) {
            ctx.save();
            
            if (instance.rotationDeg) {
              const centerX = x + width / 2;
              const centerY = y + height / 2;
              ctx.translate(centerX, centerY);
              ctx.rotate((instance.rotationDeg * Math.PI) / 180);
              ctx.drawImage(img, -width / 2, -height / 2, width, height);
            } else {
              ctx.drawImage(img, x, y, width, height);
            }
            
            ctx.restore();
          }
          
          // Draw bounding box
          ctx.strokeStyle = 'rgba(255, 255, 255, 0.6)';
          ctx.lineWidth = 1;
          ctx.setTransform(1, 0, 0, 1, 0, 0);
          
          if (instance.rotationDeg) {
            const centerX = x + width / 2;
            const centerY = y + height / 2;
            ctx.save();
            ctx.translate(centerX, centerY);
            ctx.rotate((instance.rotationDeg * Math.PI) / 180);
            ctx.strokeRect(-width / 2, -height / 2, width, height);
            ctx.restore();
          } else {
            ctx.strokeRect(x, y, width, height);
          }
          
          // Draw label
          ctx.fillStyle = 'rgba(255, 255, 255, 0.8)';
          ctx.font = '11px sans-serif';
          ctx.textAlign = 'left';
          ctx.textBaseline = 'top';
          const labelText = design.name || 'Design';
          ctx.fillText(labelText, x + 3, y + 3);
        });
      }

      function renderOrderList(orders) {
        const listEl = document.getElementById("ops-order-list");
        const statusEl = document.getElementById("ops-orders-status");
        if (!listEl || !statusEl) return;

        const pending = orders.filter((o) => o.status === "pending").length;
        setText(
          statusEl,
          pending
            ? `${pending} pending ${pending === 1 ? "job" : "jobs"}`
            : "No pending jobs."
        );

        listEl.innerHTML = "";

        orders.forEach((order, index) => {
          const files = Array.isArray(order.files) ? order.files : [];
          const created = new Date(order.created_at);
          const due = addBusinessDays(created, 3);
          const statusLower = (order.status || "pending").toLowerCase();

          const row = document.createElement("div");
          row.className = "ops-order-row";
          row.setAttribute("data-order-id", String(order.id));
          if (index === 0) {
            row.classList.add("ops-order-row--selected");
          }

          row.innerHTML = `
            <div class="ops-order-thumb" data-thumb-for="${order.id}">
              ${
                files.length
                  ? '<div class="ops-order-thumb-empty">Loading…</div>'
                  : '<div class="ops-order-thumb-empty">No art</div>'
              }
            </div>
            <div class="ops-order-main">
              <div class="ops-order-top-row">
                <div class="ops-order-job">${
                  order.transfer_name || "Untitled job"
                }</div>
                <div class="ops-order-due">
                  <span class="ops-pill ops-pill--muted">
                    #${order.id}
                  </span>
                </div>
              </div>
              <div class="ops-order-meta">
                <span class="ops-pill ops-pill--soft">
                  Received · ${formatShortDateTime(created)}
                </span>
                <span class="ops-pill ops-pill--due">
                  Due · ${formatShortDate(due)} (3 business days)
                </span>
              </div>
              <div class="ops-order-quickline">
                ${order.quantity || "—"} × ${order.size || "size n/a"} · ${
            order.garment_color || "garment color n/a"
          }
              </div>
            </div>
            <div class="ops-order-actions">
              <span class="ops-status-pill ops-status-pill--${statusLower}">
                ${statusLower}
              </span>
              <button
                type="button"
                class="ops-mark-complete"
                data-order-id="${order.id}"
                ${order.status === "completed" ? "disabled" : ""}
              >
                Mark completed
              </button>
            </div>
          `;

          listEl.appendChild(row);

          const thumb = row.querySelector(
            '.ops-order-thumb[data-thumb-for="' + order.id + '"]'
          );
          if (thumb) {
            loadThumbnail(order, thumb);
          }
        });

        if (orders.length) {
          renderOrderDetail(orders[0]);
        }
      }

      async function loadOrders() {
        const ordersPanel = document.getElementById("ops-orders");
        const loginPanel = document.getElementById("ops-login");
        const statusEl = document.getElementById("ops-orders-status");
        try {
          setText(statusEl, "Loading orders…");
          const res = await opsFetch("/api/operator/orders");
          const data = await res.json();
          if (!data.ok) throw new Error(data.error || "Failed to load orders.");

          loginPanel.style.display = "none";
          ordersPanel.style.display = "";
          OPS_CURRENT_ORDERS = data.orders || [];
          renderOrderList(OPS_CURRENT_ORDERS);
        } catch (err) {
          console.error(err);
          if (err.message === "unauthorized") {
            // show login
            document.getElementById("ops-login").style.display = "";
            document.getElementById("ops-orders").style.display = "none";
          } else {
            setText(
              statusEl,
              "Failed to load orders. Check your connection or try again."
            );
          }
        }
      }

      document.addEventListener("DOMContentLoaded", () => {
        const loginForm = document.getElementById("ops-login-form");
        const loginStatus = document.getElementById("ops-login-status");

        loginForm.addEventListener("submit", async (event) => {
          event.preventDefault();
          setText(loginStatus, "");
          const formData = new FormData(loginForm);
          const payload = {
            username: formData.get("username"),
            password: formData.get("password"),
          };

          try {
            const res = await fetch("/api/operator/login", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              credentials: "include",
              body: JSON.stringify(payload),
            });
            const data = await res.json();
            if (!res.ok || !data.ok) {
              throw new Error(data.error || "Login failed.");
            }
            setText(loginStatus, "");
            await loadOrders();
          } catch (err) {
            console.error(err);
            setText(
              loginStatus,
              "Login failed. Check your credentials and try again."
            );
          }
        });

        const opsRoot = document.getElementById("ops-root");
        if (!opsRoot) return;

        opsRoot.addEventListener("click", async (event) => {
            const viewBtn = event.target.closest(".ops-view-file");
            if (viewBtn) {
              const orderId = viewBtn.getAttribute("data-order-id");
              const index = viewBtn.getAttribute("data-file-index") || "0";
              if (!orderId) return;
              try {
                const res = await opsFetch(
                  `/api/operator/file?orderId=${orderId}&index=${index}`
                );
                const data = await res.json();
                if (!res.ok || !data.ok || !data.url) {
                  throw new Error(data.error || "Failed to open file.");
                }
                // Redirect the current tab to the artwork URL. This behaves
                // like a direct download or inline view depending on the file
                // type and will not be blocked by popup blockers.
                window.location.href = data.url;
              } catch (err) {
                console.error(err);
                alert("Failed to open artwork file.");
              }
              return;
            }

            const btn = event.target.closest(".ops-mark-complete");
            if (btn) {
              const orderId = btn.getAttribute("data-order-id");
              if (!orderId) return;

              btn.disabled = true;
              try {
                const res = await opsFetch("/api/operator/orders", {
                  method: "PATCH",
                  headers: { "Content-Type": "application/json" },
                  body: JSON.stringify({
                    orderId: Number(orderId),
                    status: "completed",
                  }),
                });
                const data = await res.json();
                if (!res.ok || !data.ok) {
                  throw new Error(data.error || "Failed to update order.");
                }
                await loadOrders();
              } catch (err) {
                console.error(err);
                btn.disabled = false;
                alert("Failed to mark order as completed.");
              }
              return;
            }

            const row = event.target.closest(".ops-order-row");
            if (!row) return;
            const idStr = row.getAttribute("data-order-id");
            if (!idStr) return;

            const orderIdNum = Number(idStr);
            const order = OPS_CURRENT_ORDERS.find(
              (o) => Number(o.id) === orderIdNum
            );
            if (!order) return;

            document
              .querySelectorAll(".ops-order-row--selected")
              .forEach((el) => el.classList.remove("ops-order-row--selected"));
            row.classList.add("ops-order-row--selected");

            renderOrderDetail(order);
          });

        loadOrders();
      });
    </script>
    <style>
      .ops-view-gang-sheet-btn {
        margin-top: 0.5rem;
        padding: 0.6rem 1.2rem;
        border-radius: 999px;
        border: 1px solid rgba(255, 255, 255, 0.2);
        background: rgba(255, 255, 255, 0.1);
        color: #f5f5f5;
        font-size: 0.8rem;
        letter-spacing: 0.1em;
        text-transform: uppercase;
        font-weight: 600;
        cursor: pointer;
        transition: all 140ms ease-out;
      }
      
      .ops-view-gang-sheet-btn:hover {
        background: rgba(255, 255, 255, 0.15);
        border-color: rgba(255, 255, 255, 0.3);
        transform: translateY(-1px);
      }
      
      .ops-gang-sheet-modal {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.85);
        backdrop-filter: blur(8px);
        z-index: 10000;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 2rem;
        overflow: auto;
      }
      
      .ops-gang-sheet-modal-content {
        width: 100%;
        max-width: 1400px;
        max-height: 90vh;
        border-radius: 1rem;
        background: radial-gradient(
            circle at top left,
            rgba(255, 255, 255, 0.05),
            transparent 55%
          ),
          rgba(7, 8, 12, 0.98);
        border: 1px solid rgba(255, 255, 255, 0.1);
        display: flex;
        flex-direction: column;
        overflow: hidden;
      }
      
      .ops-gang-sheet-modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1.5rem;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      }
      
      .ops-gang-sheet-modal-title {
        margin: 0;
        font-size: 1.1rem;
        font-weight: 600;
        color: #f5f5f5;
      }
      
      .ops-gang-sheet-modal-close {
        width: 2rem;
        height: 2rem;
        border-radius: 50%;
        border: 1px solid rgba(255, 255, 255, 0.2);
        background: rgba(255, 255, 255, 0.1);
        color: #f5f5f5;
        font-size: 1.5rem;
        line-height: 1;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 140ms ease-out;
      }
      
      .ops-gang-sheet-modal-close:hover {
        background: rgba(255, 255, 255, 0.2);
        border-color: rgba(255, 255, 255, 0.3);
      }
      
      .ops-gang-sheet-modal-body {
        padding: 1.5rem;
        overflow: auto;
        flex: 1;
      }
      
      .ops-gang-sheet-info-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 1rem;
        margin-bottom: 1.5rem;
        padding: 1rem;
        background: rgba(10, 11, 15, 0.6);
        border-radius: 0.7rem;
        border: 1px solid rgba(255, 255, 255, 0.08);
      }
      
      .ops-gang-sheet-info-item {
        display: flex;
        flex-direction: column;
        gap: 0.25rem;
      }
      
      .ops-gang-sheet-canvas-wrapper {
        width: 100%;
        overflow: auto;
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 0.7rem;
        background: rgba(10, 11, 15, 0.4);
        padding: 1.5rem;
        display: flex;
        justify-content: center;
        align-items: flex-start;
      }
      
      .ops-gang-sheet-canvas {
        display: block;
        max-width: 100%;
        height: auto;
      }
    </style>
  </body>
</html>


